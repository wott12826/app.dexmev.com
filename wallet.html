<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="_next/static/css/ea903d5c6198cacb.css" data-precedence="next">
    <link data-rh="true" rel="icon" href="favicon-logo.svg">
    <title>DM Wallet</title>
    <meta name="description" content="DM Wallet description">
    <style>
      html, body {
        width: 100vw;
        min-height: 100vh;
        margin: 0;
        padding: 0;
        background: #18181b;
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 100vh;
        width: 100vw;
        overflow-x: hidden;
      }
      .wallet-mobile-container {
        max-width: 480px;
        width: 100vw;
        margin: 0 auto;
        padding: 16px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: transparent;
      }
      .wallet-mobile-section {
        width: 100%;
        margin-bottom: 12px;
        background: none;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .wallet-mobile-actions {
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 12px;
      }
      .wallet-mobile-actions button {
        flex: 1 1 0;
        min-width: 0;
        width: 100%;
        font-size: 1rem;
        min-height: 44px;
        border-radius: 8px;
      }
      .wallet-balance-block, .wallet-address-block {
        width: 100%;
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: none;
      }
      .wallet-balance-block .text-secondary, .wallet-address-block .text-secondary {
        font-size: 1rem;
      }
      .wallet-balance-block .text-green {
        font-size: 1.5rem;
      }
      .wallet-address-block button, .wallet-address-block input {
        width: 100%;
        font-size: 1rem;
      }
      .wallet-mobile-section img, .wallet-mobile-section svg, .wallet-mobile-section canvas {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
      }
      .wallet-mobile-section h1, .wallet-mobile-section h2, .wallet-mobile-section h3, .wallet-mobile-section p, .wallet-mobile-section span, .wallet-mobile-section label {
        font-size: 1rem !important;
      }
      .wallet-mobile-section .font-bold {
        font-weight: 600 !important;
      }
      .wallet-mobile-section .rounded {
        border-radius: 8px !important;
      }
      .wallet-mobile-section .overflow-x-auto,
      .wallet-mobile-section .overflow-hidden {
        overflow-x: visible !important;
      }
      /* Transaction table vertical on mobile */
      @media (max-width: 600px) {
        .wallet-mobile-container { max-width: 100vw; }
        .wallet-mobile-section { max-width: 100vw; }
        .wallet-mobile-section table, .wallet-mobile-section .transactions-table {
          display: block !important;
          width: 100% !important;
        }
        .wallet-mobile-section thead { display: none !important; }
        .wallet-mobile-section tbody, .wallet-mobile-section tr {
          display: block !important;
          width: 100% !important;
        }
        .wallet-mobile-section tr {
          margin-bottom: 10px !important;
          border-bottom: 1px solid #222;
          background: none !important;
        }
        .wallet-mobile-section td {
          display: flex !important;
          width: 100% !important;
          font-size: 0.95rem !important;
          padding: 4px 0 !important;
          align-items: center;
        }
        .wallet-mobile-section td:before {
          content: attr(data-label);
          flex: 0 0 110px;
          color: #888;
          font-size: 0.85rem;
          margin-right: 8px;
        }
      }
      /* Footer and notifications always inside container */
      .wallet-mobile-footer, [role="region"][aria-label*="Notifications"] {
        max-width: 480px;
        margin: 0 auto;
        width: 100vw;
        box-sizing: border-box;
      }
    </style>
</head>

<body class="antialiased">
    <div class="wallet-mobile-container">
      <header class="wallet-mobile-section">
        <h1 class="text-[32px] font-semibold" style="text-align:center;">Wallet</h1>
      </header>
      <section class="wallet-mobile-section wallet-mobile-actions">
        <button class="bg-gradient-to-br from-[#14F195] to-[#005330ca] text-green">Deposit</button>
        <button class="bg-gradient-to-br from-[#000000b0] to-[#ffffff15] text-secondary">Withdraw</button>
        <button class="bg-gradient-to-br from-[#FF00FF] to-[#930093] text-white">Buy</button>
      </section>
      <section class="wallet-mobile-section wallet-balance-block">
        <span class="text-secondary">Balance:</span>
        <span class="font-bold text-green" id="solBalance">0</span> <span>SOL</span>
      </section>
      <section class="wallet-mobile-section wallet-address-block">
        <span class="text-secondary">Address</span>
        <button id="walletSolanaBtn" style="width:100%;margin-bottom:8px;">
          <span id="walletSolanaText" class="text-sm text-secondary">Connect Wallet</span>
        </button>
        <button id="disconnectWalletBtn" style="width:100%;display:none;margin-bottom:8px;" class="bg-gradient-to-br from-[#FF00FF] to-[#930093] text-white">Disconnect Wallet</button>
        <svg id="copyWalletIcon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewbox="0 0 11 13" style="cursor:pointer;display:none;margin:auto;">
          <path fill="#fff" d="M4 10.667a1.133 1.133 0 0 1-1.2-1.2v-7.6c0-.334.133-.667.4-.867.2-.2.533-.333.867-.333H9.6c.333 0 .667.133.867.333.266.266.333.533.333.867v7.6c0 .333-.067.666-.333.866-.2.2-.534.333-.867.333H4M1.8 13c-.333 0-.667-.133-.867-.334C.667 12.4.6 12.134.6 11.8V3.667c0-.2 0-.267.133-.4l.334-.134c.133 0 .266 0 .333.134.133.133.133.2.133.4v8l.067.2.2.066h6c.2 0 .333 0 .4.133.133.133.133.2.133.4 0 .134 0 .2-.133.334l-.333.133H1.733z"></path>
        </svg>
      </section>
      <section class="wallet-mobile-section">
        <div class="wallet-balance-block">
          <span class="text-secondary">Your Trading Balance</span>
          <div class="flex items-center gap-2" style="width:100%;justify-content:center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewbox="0 0 24 20" style="max-width:32px;">
              <path fill="url(#solana-without-bg_svg__a)" d="M3.923 14.949a.77.77 0 0 1 .548-.232h19.144a.41.41 0 0 1 .277.687L20.11 19.18a.77.77 0 0 1-.548.231H.42a.394.394 0 0 1-.278-.695z"></path>
              <path fill="url(#solana-without-bg_svg__b)" d="M3.922.821A.77.77 0 0 1 4.47.59h19.143A.386.386 0 0 1 24 .99a.4.4 0 0 1-.108.27l-3.782 3.791a.77.77 0 0 1-.548.232H.417a.41.41 0 0 1-.277-.687z"></path>
              <path fill="url(#solana-without-bg_svg__c)" d="M20.109 7.839a.77.77 0 0 0-.548-.232H.417a.41.41 0 0 0-.277.687l3.782 3.768a.77.77 0 0 0 .548.231h19.143a.394.394 0 0 0 .386-.401.4.4 0 0 0-.108-.27z"></path>
            </svg>
            <span class="text-[32px] font-medium">0</span><span class="relative -top-[3px] ml-0.5 text-green">/ $0.00</span>
          </div>
        </div>
      </section>
      <section class="wallet-mobile-section">
        <h2 class="font-semibold">User Transaction Live Stream</h2>
        <div class="mt-3 h-px bg-gd-divider opacity-[32%]" style="width:100%;"></div>
        <div class="relative mt-7 overflow-x-auto" style="width:100%;">
          <table class="transactions-table" style="width:100%;">
            <thead>
              <tr>
                <th>#</th>
                <th>Time</th>
                <th>Token</th>
                <th>Cost</th>
                <th>Revenue</th>
                <th>Profit</th>
                <th>Block</th>
                <th>Delay</th>
                <th>Dex</th>
                <th>Type</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="10">
                  <div class="flex items-center justify-center text-white text-3xl" style="font-size:1.2rem;">Transactions not found</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
      <footer class="wallet-mobile-footer wallet-mobile-section">
        <button id="logoutBtn" data-firebase-logout="true" data-nextjs-protected="true" class="bg-gradient-to-br from-[#000000b0] to-[#ffffff15] text-white" style="width:100%;margin-bottom:8px;">Log Out</button>
      </footer>
      <div role="region" aria-label="Notifications (F8)" tabindex="-1" style="pointer-events:none" class="wallet-mobile-footer">
        <ol tabindex="-1" class="flex max-h-screen w-full flex-col-reverse p-4 md:max-w-[420px]" style="width:100%;max-width:100vw;"></ol>
      </div>
    </div>
    
    <!-- Firebase Configuration -->
    <script type="module" src="firebase-config.js"></script>
    
    <!-- Firebase Authentication Script -->
    <script type="module">
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Wallet page loaded, setting up logout functionality...');
            
            // Function to get protected logout button
            const getProtectedLogoutBtn = () => {
                const button = document.querySelector('[data-firebase-logout="true"]') || 
                              document.getElementById('logoutBtn');
                console.log('Found logout button:', button);
                return button;
            };
            
            const logoutBtn = getProtectedLogoutBtn();
            
            if (logoutBtn) {
                console.log('Adding click event listener to logout button...');
                
                logoutBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    console.log('Logout button clicked!');
                    
                    try {
                        // Show loading state
                        logoutBtn.style.opacity = '0.5';
                        logoutBtn.style.pointerEvents = 'none';
                        
                        console.log('Waiting for Firebase to be loaded...');
                        
                        // Wait for Firebase to be loaded
                        let attempts = 0;
                        while (!window.firebaseAuth && attempts < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            attempts++;
                        }
                        
                        if (!window.firebaseAuth) {
                            throw new Error('Firebase not loaded after 5 seconds');
                        }
                        
                        console.log('Firebase loaded, calling signOut...');
                        
                        const result = await window.firebaseAuth.signOut();
                        
                        console.log('Sign out result:', result);
                        
                        if (result.success) {
                            // Success - redirect will be handled by auth state listener
                            console.log('Sign out successful, redirecting...');
                            alert('Successfully signed out!');
                        } else {
                            console.error('Sign out error:', result.error);
                            alert('Error signing out: ' + result.error);
                        }
                    } catch (error) {
                        console.error('Sign out error:', error);
                        alert('An unexpected error occurred: ' + error.message);
                    } finally {
                        // Restore button state
                        logoutBtn.style.opacity = '0.9';
                        logoutBtn.style.pointerEvents = 'auto';
                    }
                });
                
                console.log('Logout event listener added successfully');
            } else {
                console.error('Logout button not found!');
            }
        });
    </script>
    <script type="module">
        const walletBtn = document.getElementById('walletSolanaBtn');
        const walletText = document.getElementById('walletSolanaText');
        const copyIcon = document.getElementById('copyWalletIcon');
        const disconnectBtn = document.getElementById('disconnectWalletBtn');
        const WALLET_STATE_KEY = 'wallet-event';
        const WALLET_CONNECTED_KEY = 'wallet-connected';

        console.log('Wallet page - Wallet elements found:', {
            walletBtn: !!walletBtn,
            walletText: !!walletText,
            copyIcon: !!copyIcon,
            disconnectBtn: !!disconnectBtn
        });

        function shortAddress(addr) {
            if (!addr) return '';
            return addr.slice(0, 4) + '...' + addr.slice(-4);
        }

        async function getSolBalance() {
            const balanceElement = document.getElementById('solBalance');
            if (!balanceElement) return;

            if (window.solana && window.solana.isPhantom && window.solana.publicKey) {
                try {
                    const balance = await window.solana.connection.getBalance(window.solana.publicKey);
                    const solBalance = balance / 1000000000;
                    balanceElement.textContent = solBalance.toFixed(4);
                    console.log('Wallet page - SOL balance updated:', solBalance.toFixed(4));
                } catch (error) {
                    console.error('Wallet page - Error getting SOL balance:', error);
                    balanceElement.textContent = '0';
                }
            } else {
                balanceElement.textContent = '0';
            }
        }

        async function updateWalletBtn() {
            console.log('Wallet page - updateWalletBtn called');
            const isConnected = localStorage.getItem('wallet-connected') === 'true';
            if (!isConnected) {
                console.log('Wallet page - Wallet is marked as disconnected, forcing disconnected state');
                walletText.textContent = 'Connect Wallet';
                copyIcon.style.display = 'none';
                disconnectBtn.style.display = 'none';
                document.getElementById('solBalance').textContent = '0';
                return;
            }
            if (window.solana && window.solana.isPhantom) {
                let pubKey = '';
                try {
                    await window.solana.connect({ onlyIfTrusted: true });
                    pubKey = window.solana.publicKey ? window.solana.publicKey.toString() : '';
                } catch (e) {
                    pubKey = '';
                }
                if (pubKey) {
                    walletText.innerHTML = `Wallet Solana: <span class="ml-2.5 text-blue" id="walletShortAddr">${shortAddress(pubKey)}</span>`;
                    copyIcon.style.display = 'inline-block';
                    disconnectBtn.style.display = 'inline-block';
                    localStorage.setItem('wallet-connected', 'true');
                    await getSolBalance();
                } else {
                    walletText.textContent = 'Connect Wallet';
                    copyIcon.style.display = 'none';
                    disconnectBtn.style.display = 'none';
                    localStorage.setItem('wallet-connected', 'false');
                    document.getElementById('solBalance').textContent = '0';
                }
            } else {
                walletText.textContent = 'Connect Wallet';
                copyIcon.style.display = 'none';
                disconnectBtn.style.display = 'none';
                localStorage.setItem('wallet-connected', 'false');
                document.getElementById('solBalance').textContent = '0';
            }
        }

        walletBtn.addEventListener('click', async () => {
            console.log('Wallet page - Wallet button clicked, current text:', walletText.textContent);
            if (walletText.textContent !== 'Connect Wallet') return;

            if (window.solana && window.solana.isPhantom) {
                console.log('Wallet page - Attempting to connect to Phantom wallet...');
                try {
                    await window.solana.connect();
                    console.log('Wallet page - Successfully connected to Phantom wallet');
                    localStorage.setItem(WALLET_CONNECTED_KEY, 'true');
                    updateWalletBtn();
                    localStorage.setItem(WALLET_STATE_KEY, JSON.stringify({ event: 'connect', ts: Date.now() }));
                    console.log('Wallet page - Wallet state synchronized');
                } catch (e) { 
                    console.error('Wallet page - Error connecting to wallet:', e);
                    alert('Error connecting to wallet: ' + e.message);
                }
            } else {
                console.log('Wallet page - Phantom wallet not available, opening download page');
                window.open('https://phantom.app/', '_blank');
            }
        });

        copyIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            console.log('Wallet page - Copy icon clicked');
            if (window.solana && window.solana.publicKey) {
                const address = window.solana.publicKey.toString();
                console.log('Wallet page - Copying address to clipboard:', address);
                navigator.clipboard.writeText(address);
                copyIcon.style.opacity = 0.5;
                setTimeout(() => { copyIcon.style.opacity = 1; }, 500);
                console.log('Wallet page - Address copied to clipboard');
            } else {
                console.log('Wallet page - No wallet address to copy');
            }
        });

        disconnectBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            console.log('Wallet page - Disconnect button clicked!');
            
            if (window.solana && window.solana.isPhantom) {
                console.log('Wallet page - Phantom wallet found, attempting to disconnect...');
                try {
                    // Отключаем кошелек
                    await window.solana.disconnect();
                    console.log('Wallet page - Wallet disconnected successfully');
                    
                    // Обновляем статус подключения
                    localStorage.setItem(WALLET_CONNECTED_KEY, 'false');
                    
                    // Принудительно обновляем UI
                    walletText.textContent = 'Connect Wallet';
                    copyIcon.style.display = 'none';
                    disconnectBtn.style.display = 'none';
                    
                    // Синхронизируем с другими страницами
                    localStorage.setItem(WALLET_STATE_KEY, JSON.stringify({ event: 'disconnect', ts: Date.now() }));
                    console.log('Wallet page - Wallet state updated and synchronized');
                    
                    // Показываем подтверждение пользователю
                    console.log('Wallet page - Wallet disconnected and UI updated');
                    
                    // Добавляем небольшую задержку перед вызовом updateWalletBtn
                    setTimeout(() => {
                        updateWalletBtn();
                    }, 100);
                    
                } catch (e) { 
                    console.error('Wallet page - Error disconnecting wallet:', e);
                    alert('Error disconnecting wallet: ' + e.message);
                }
            } else {
                console.log('Wallet page - Phantom wallet not found');
                alert('Phantom wallet not found');
            }
        });
        
        window.addEventListener('storage', (e) => {
            console.log('Wallet page - Storage event detected:', e.key, e.newValue);
            if (e.key === WALLET_STATE_KEY || e.key === WALLET_CONNECTED_KEY) {
                console.log('Wallet page - Wallet state change detected, updating UI');
                updateWalletBtn();
            }
        });

        console.log('Wallet page - Initializing wallet state...');
        updateWalletBtn();
        console.log('Wallet page - Wallet initialization complete');
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Wallet page - DOM loaded');
        });
    </script>
    <script src="firebase-config.js" type="module"></script>
</body>

</html>